// Copyright (c) CBC/Radio-Canada. All rights reserved.
// Licensed under the MIT license. See LICENSE file in the project root for full license information.

var moby={version:"0.1.0"};moby.idx=0,moby.init=function(t){var e=null,n={line:moby.renderLine,bar2D:moby.renderBar2D,bubble:moby.renderBubble,bar:moby.renderBar},o={};return o.config={containerSelector:null,width:300,height:200,type:"bar",transitionDuration:400,labelFormatter:moby.utils.formatLabel,tooltipFormatter:moby.utils.formatTooltip,colorByKey:null,sortByKey:null,labelRadiusThreshold:20,colors:null},o.setConfig=function(t){return moby.utils.override(t,this.config),this},o.setConfig(t),o.events=d3.dispatch("hover","hoverout","click"),o.tooltip=moby.tooltip.call(o),o.render=function(t){t?e=t:t=e;var o=d3.select(this.config.containerSelector).node();return this.config.width=o.offsetWidth,this.config.height=o.offsetHeight,n[this.config.type].call(this,t),this},d3.rebind(o,o.events,"on"),d3.select(window).on("resize."+moby.idx++,moby.utils.debounce(function(){o.render()},300)),o},moby.utils={},moby.utils.formatLabel=function(t){var e="";return t.name&&(e+='<span class="label-title">'+t.name+"</span>"),t.values&&(e+='<span class="label-value"> ('+d3.max(t.values)+")</span>"),e},moby.utils.formatTooltip=function(t){var e="";return t.name&&(e+='<span class="label-title">'+t.name+"</span>"),t.values&&(e+='<span class="label-value"> ('+d3.max(t.values)+")</span>"),e},moby.utils.generateRandomString=function(){return d3.range(~~(20*Math.random())+5).map(function(){return String.fromCharCode(26*Math.random()+65)}).join("")},moby.utils.generateData1D=function(t){return d3.range(t).map(function(){return{name:moby.utils.generateRandomString(),values:[~~(100*Math.random())]}})},moby.utils.generateData2D=function(t,e){return d3.range(t).map(function(){return{name:moby.utils.generateRandomString(),values:d3.range(e).map(function(){return~~(100*Math.random())})}})},moby.utils.debounce=function(t,e,n){var o;return function(){var i=this,r=arguments;clearTimeout(o),o=setTimeout(function(){o=null,n||t.apply(i,r)},e),n&&!o&&t.apply(i,r)}},moby.utils.override=function(t,e){for(var n in t)n in e&&(e[n]=t[n])},moby.utils.colorPicker=d3.scale.category20,moby.tooltip=function(){var t={},e=d3.select(this.config.containerSelector).append("div").attr({"class":"chart-tooltip"}).style({position:"absolute","pointer-events":"none",display:"none","z-index":10});return t.show=function(t,n){var o=this;e.style({left:n.pos[0]+"px",top:n.pos[1]-10+"px",display:"block"}).html(function(){return o.config.tooltipFormatter(t)})},t.hide=function(){e.style({display:"none"}).html("")},t},moby.renderLine=function(t){var e=this,n=d3.select(this.config.containerSelector),o=this.config.height/t.length,i=n.selectAll("div.chart").data(t);i.enter().append("div").attr({"class":"line chart"}),i.style({width:this.config.width+"px",height:o+"px"}),i.exit().remove();var r=i.selectAll("div.line").data(function(t){return t.values});r.enter().append("div").attr({"class":"line"}).style({height:"2px",width:function(n,o,i){return e.config.width/t[i].values.length+"px"},left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o+r/2+"px"},"-webkit-transform-origin":"0% 0%","transform-origin":"0% 0%","-webkit-transform":"rotate(0rad)",transform:"rotate(0rad)",position:"absolute"});var a=function(t,n){var i=this.parentNode.__data__,r=o-t*o/d3.max(i.values),a=Math.min(n+1,i.values.length-1),l=o-i.values[a]*o/d3.max(i.values),s=l-r,u=e.config.width/i.values.length;return d3.interpolateString(this.style.webkitTransform,"rotate("+Math.atan2(s,u)+"rad)")};r.transition().duration(this.config.transitionDuration).styleTween("-webkit-transform",a).styleTween("transform",a).style({width:function(t,n){var i=this.parentNode.__data__,r=o-t*o/d3.max(i.values),a=Math.min(n+1,i.values.length-1),l=o-i.values[a]*o/d3.max(i.values),s=l-r,u=e.config.width/i.values.length;return Math.sqrt(s*s+u*u)+"px"},top:function(e,n,i){return o-e*o/d3.max(t[i].values)+"px"},left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o+r/2+"px"},display:function(e,n,o){return n===t[o].values.length-1?"none":"block"}}),r.exit().remove();var l=5,s=i.selectAll("div.dot").data(function(t){return t.values});s.enter().append("div").attr({"class":"dot"}).style({left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o-l+r/2+"px"},top:function(e,n,i){return o-e*o/d3.max(t[i].values)-l+"px"},width:2*l+"px",height:2*l+"px","border-radius":l+"px",position:"absolute"}).on("mousemove",function(o,i,r){d3.select(this).classed("hover",!0);var a=d3.mouse(n.node());e.tooltip.show.call(e,{name:t[r].name,values:[o]},{pos:a}),e.events.hover.call(e,o,{pos:a})}).on("mouseout",function(t){d3.select(this).classed("hover",!1);var o=d3.mouse(n.node());e.tooltip.hide.call(e),e.events.hoverout.call(e,t,{pos:o})}),s.transition().duration(this.config.transitionDuration).style({left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o-l+r/2+"px"},top:function(e,n,i){return o-e*o/d3.max(t[i].values)-l+"px"},width:2*l+"px",height:2*l+"px","border-radius":l+"px",position:"absolute"}),s.exit().remove();var u=i.selectAll("div.label").data(function(t){return t.values});return u.enter().append("div").attr({"class":"label"}).style({left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o+"px"},top:function(){var t=parseInt(window.getComputedStyle(this).fontSize,10);return o-t+"px"},position:"absolute","pointer-events":"none"}),u.html(function(n,o,i){return e.config.labelFormatter(t[i],o)}).transition().duration(this.config.transitionDuration).style({left:function(n,o,i){var r=e.config.width/t[i].values.length;return r*o+"px"},top:function(){var t=parseInt(window.getComputedStyle(this).fontSize,10);return o-t+"px"}}),u.exit().remove(),this},moby.renderBar=function(t){var e=this,n=this.config.colors||moby.utils.colorPicker(),o=d3.select(this.config.containerSelector),i=o.selectAll("div.chart").data(t);i.enter().append("div").attr({"class":"bar chart"}).on("mousemove",function(t){d3.select(this).select(".bar").classed("hover",!0);var n=d3.mouse(o.node());e.tooltip.show.call(e,t,{pos:n}),e.events.hover.call(e,t,{pos:n})}).on("mouseout",function(t){d3.select(this).select(".bar").classed("hover",!1);var n=d3.mouse(o.node());e.tooltip.hide.call(e),e.events.hoverout.call(e,t,{pos:n})}),i.style({width:this.config.width+"px",height:this.config.height/t.length+"px"}),i.exit().remove();var r=i.selectAll("div.bar").data(function(t){return t.values});r.enter().append("div").attr({"class":"bar"}).style({width:this.config.width+"px",height:"100%"}),r.transition().duration(this.config.transitionDuration).style({width:function(n){return n/d3.max(d3.merge(t.map(function(t){return t.values})))*e.config.width-2+"px"},"background-color":function(o,i,r){var a=e.config.colorByKey;return a&&t[r]?n(t[r][a]):null}}),r.exit().remove();var a=i.selectAll("div.label").data(function(t){return[t]});a.enter().append("div").attr({"class":"label"}).style({width:this.config.width+"px",height:"100%",position:"absolute"}),a.style({width:this.config.width+"px"}).html(this.config.labelFormatter),a.exit().remove()},moby.renderBar2D=function(t){var e=this,n=d3.select(this.config.containerSelector),o=this.config.height/t.length,i=n.selectAll("div.chart").data(t);i.enter().append("div").attr({"class":"bar2d chart"}),i.style({width:this.config.width+"px",height:o+"px"}),i.exit().remove();var r=i.selectAll("div.bar").data(function(t){return t.values});r.enter().append("div").attr({"class":"bar"}).style({left:function(n,o,i){return o*e.config.width/t[i].values.length+"px"},top:o+"px",width:function(n,o,i){return e.config.width/t[i].values.length+"px"},height:"0px",position:"absolute"}).on("mousemove",function(o,i,r){d3.select(this).classed("hover",!0);var a=d3.mouse(n.node());e.tooltip.show.call(e,{name:t[r].name,values:[o]},{pos:a}),e.events.hover.call(e,o,{pos:a})}).on("mouseout",function(t){d3.select(this).classed("hover",!1);var o=d3.mouse(n.node());e.tooltip.hide.call(e),e.events.hoverout.call(e,t,{pos:o})}),r.transition().duration(this.config.transitionDuration).style({left:function(n,o,i){return o*e.config.width/t[i].values.length+"px"},top:function(e,n,i){return o-e*o/d3.max(t[i].values)+"px"},width:function(n,o,i){return e.config.width/t[i].values.length-2+"px"},height:function(e,n,i){return e/d3.max(t[i].values)*o-2+"px"}}),r.exit().remove();var a=i.selectAll("div.label").data(function(t){return t.values});return a.enter().append("div").attr({"class":"label"}).style({left:function(n,o,i){return o*e.config.width/t[i].values.length+"px"},top:function(){var t=parseInt(window.getComputedStyle(this).fontSize,10);return o-t+"px"},position:"absolute","pointer-events":"none"}),a.html(function(n,o,i){return e.config.labelFormatter(t[i],o)}).transition().duration(this.config.transitionDuration).style({left:function(n,o,i){var r=e.config.width/t[i].values.length;return o*r+r/10+"px"},top:function(){var t=parseInt(window.getComputedStyle(this).fontSize,10);return o-1.4*t+"px"}}),a.exit().remove(),this},moby.renderBubble=function(t){var e=this,n=t.map(function(t){return{key:t.name,value:t.values[0],data:t}}),o=e.config.sortByKey,i=d3.layout.pack().sort(function(t,e){return o?d3.ascending(e.data[o],t.data[o]):d3.ascending(e.value,t.value)}).size([this.config.width,this.config.height]).padding(2).value(function(t){return t.value}),r=this.config.colors||moby.utils.colorPicker(),a=d3.select(this.config.containerSelector),l=a.selectAll("div.chart").data([0]);l.enter().append("div").attr({"class":"bubble chart"}),l.style({width:this.config.width+"px",height:this.config.height+"px"});var s=function(t){return"translate("+(t.x-t.r)+"px,"+(t.y-t.r)+"px)"},u=function(t){return d3.interpolateString(this.style.webkitTransform,s(t))},c=l.selectAll(".node").data(i.nodes({key:"a",value:1,children:n}),function(t){return t.key});return c.enter().append("div").attr({"class":"node"}).style({"-webkit-transform":s,transform:s,width:"0px",height:"0px","border-radius":function(t){return t.r+"px"},position:"absolute","text-align":"center"}).on("mousemove",function(t){d3.select(this).classed("hover",!0);var n=d3.mouse(a.node());e.tooltip.show.call(e,{name:t.key,values:[t.value]},{pos:n}),e.events.hover.call(e,t,{pos:n})}).on("mouseout",function(t){d3.select(this).classed("hover",!1);var n=d3.mouse(a.node());e.tooltip.hide.call(e),e.events.hoverout.call(e,t,{pos:n})}).on("click",function(t){d3.select(this).classed("hover",!1),e.tooltip.hide.call(e);var n=d3.mouse(a.node());e.events.click.call(e,t,{pos:n})}).append("span").attr({"class":"label-container"}).style({"font-size":"10px","pointer-events":"none",position:"absolute",left:0}),c.selectAll(".label-container").html(""),c.transition().duration(this.config.transitionDuration).styleTween("-webkit-transform",u).styleTween("transform",u).style({width:function(t){return 2*t.r+"px"},height:function(t){return 2*t.r+"px"},"border-radius":function(t){return t.r+"px"},"background-color":function(n,o){var i=e.config.colorByKey;return i&&t[o-1]?r(t[o-1][i]):null}}).each("end",function(t){var n=e.config.labelFormatter({name:t.key,values:[t.value]});d3.select(this).select(".label-container").html("").filter(function(){return t.r>e.config.labelRadiusThreshold}).html(n).style({"font-size":function(){var e=parseInt(this.style.fontSize,10);return.9*~~(2*e*t.r/this.offsetWidth)+"px"},"margin-top":function(){return t.r-this.offsetHeight/2+"px"},"margin-left":function(){return.1*t.r+"px"}})}),c.exit().remove(),d3.select(c[0][0]).classed("top",!0).text(""),this};